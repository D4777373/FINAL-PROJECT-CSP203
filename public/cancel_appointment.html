<?php
// Include the database connection
include_once('../config/db.php');

// Start the session
session_start();

// Check if the form is submitted
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // Get form data
    $appointmentId = $_POST['appointmentId'];
    $patientName = $_POST['patientName'];
    $reason = isset($_POST['reason']) ? $_POST['reason'] : null;

    // Ensure user is logged in
    if (!isset($_SESSION['user_id'])) {
        // Redirect to login page if not logged in
        header("Location: login.html");
        exit();
    }

    // Get user ID from session
    $userId = $_SESSION['user_id'];

    // Check if the appointment belongs to the logged-in user
    try {
        // Query to check appointment ownership
        $checkSql = "SELECT * FROM appointments WHERE appointment_id = :appointmentId AND user_id = :userId";
        $stmt = $pdo->prepare($checkSql);
        $stmt->bindParam(':appointmentId', $appointmentId);
        $stmt->bindParam(':userId', $userId);
        $stmt->execute();

        $appointment = $stmt->fetch();

        if (!$appointment) {
            echo "Error: No appointment found with the provided ID for the logged-in user.";
            exit();
        }

        // Update the appointment status to 'cancelled'
        $updateSql = "UPDATE appointments 
                      SET status = 'cancelled', cancellation_reason = :reason 
                      WHERE appointment_id = :appointmentId";
        $updateStmt = $pdo->prepare($updateSql);
        $updateStmt->bindParam(':reason', $reason);
        $updateStmt->bindParam(':appointmentId', $appointmentId);
        $updateStmt->execute();

        echo "Appointment successfully cancelled.";
        // Optionally redirect to a confirmation or dashboard page
        // header("Location: dashboard.html");
    } catch (PDOException $e) {
        echo "Error: Unable to cancel the appointment. " . $e->getMessage();
    }
} else {
    echo "Invalid request.";
}
?>

